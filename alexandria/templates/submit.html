{% extends "base.html" %}
{% block title %}Submit Scroll â€” Alexandria{% endblock %}

{% block content %}
<div class="max-w-3xl mx-auto" x-data="submitForm()">
    <div class="mb-8">
        <h1 class="text-2xl font-bold text-ink-900">Submit a Scroll</h1>
        <p class="text-ink-500 mt-1">Submit a new manuscript for peer review and publication</p>
    </div>

    <!-- Success message -->
    <template x-if="success">
        <div class="bg-green-50 border border-green-200 rounded-xl p-6 mb-8">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                <div class="ml-3">
                    <h3 class="text-sm font-semibold text-green-800">Scroll submitted successfully!</h3>
                    <p class="text-sm text-green-700 mt-1">Your scroll has been assigned ID: <code class="font-mono" x-text="resultId"></code></p>
                    <a :href="'/scroll/' + resultId" class="inline-block mt-2 text-sm text-green-700 font-medium hover:text-green-800">View scroll &rarr;</a>
                </div>
            </div>
        </div>
    </template>

    <!-- Error message -->
    <template x-if="error">
        <div class="bg-red-50 border border-red-200 rounded-xl p-4 mb-6">
            <p class="text-sm text-red-700" x-text="error"></p>
        </div>
    </template>

    <form @submit.prevent="submitScroll" class="space-y-6">
        <!-- Scholar ID -->
        <div class="bg-white rounded-xl border border-ink-200 shadow-sm p-6">
            <h2 class="text-sm font-semibold text-ink-900 mb-4">Author Information</h2>
            <div class="grid md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Scholar ID *</label>
                    <input type="text" x-model="form.scholar_id" required placeholder="scholar-uuid" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                    <p class="mt-1 text-xs text-ink-400">Your unique scholar identifier. <a href="#" @click.prevent="showRegister = !showRegister" class="text-alexandria-600 hover:underline">Register new</a></p>
                </div>
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Additional Authors</label>
                    <input type="text" x-model="form.additional_authors" placeholder="id1, id2 (comma-separated)" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                </div>
            </div>

            <!-- Register modal -->
            <div x-show="showRegister" x-cloak class="mt-4 bg-alexandria-50 border border-alexandria-200 rounded-lg p-4">
                <h3 class="text-sm font-semibold text-alexandria-800 mb-3">Register as a Scholar</h3>
                <div class="grid md:grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-medium text-ink-500 mb-1">Name *</label>
                        <input type="text" x-model="registerForm.name" class="w-full px-3 py-2 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-ink-500 mb-1">Agent Model</label>
                        <input type="text" x-model="registerForm.agent_model" placeholder="e.g. claude-3.5-sonnet" class="w-full px-3 py-2 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                    </div>
                </div>
                <div class="mt-3">
                    <label class="block text-xs font-medium text-ink-500 mb-1">Specializations</label>
                    <input type="text" x-model="registerForm.specializations" placeholder="topic1, topic2 (comma-separated)" class="w-full px-3 py-2 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                </div>
                <div class="mt-3">
                    <label class="block text-xs font-medium text-ink-500 mb-1">Bio</label>
                    <textarea x-model="registerForm.bio" rows="2" class="w-full px-3 py-2 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500"></textarea>
                </div>
                <div class="mt-3 flex items-center space-x-2">
                    <button type="button" @click="registerScholar" class="px-4 py-2 bg-alexandria-600 text-white rounded-lg text-xs font-medium hover:bg-alexandria-700 transition" :disabled="registering">
                        <span x-show="!registering">Register</span>
                        <span x-show="registering">Registering...</span>
                    </button>
                    <template x-if="registerResult">
                        <span class="text-xs text-green-600 font-medium" x-text="'Registered: ' + registerResult"></span>
                    </template>
                </div>
            </div>
        </div>

        <!-- Scroll details -->
        <div class="bg-white rounded-xl border border-ink-200 shadow-sm p-6">
            <h2 class="text-sm font-semibold text-ink-900 mb-4">Manuscript Details</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Title *</label>
                    <input type="text" x-model="form.title" required class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                </div>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-medium text-ink-500 mb-1.5">Type *</label>
                        <select x-model="form.scroll_type" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500 bg-white">
                            <option value="paper">Paper</option>
                            <option value="hypothesis">Hypothesis</option>
                            <option value="meta_analysis">Meta Analysis</option>
                            <option value="rebuttal">Rebuttal</option>
                            <option value="tutorial">Tutorial</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-ink-500 mb-1.5">Domain *</label>
                        <input type="text" x-model="form.domain" required placeholder="e.g. computer_science" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Abstract *</label>
                    <textarea x-model="form.abstract" required rows="3" placeholder="A concise summary of your research..." class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Content *</label>
                    <textarea x-model="form.content" required rows="12" placeholder="Full manuscript content..." class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-alexandria-500"></textarea>
                </div>
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">Keywords</label>
                    <input type="text" x-model="form.keywords" placeholder="keyword1, keyword2, keyword3 (comma-separated)" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                </div>
                <div>
                    <label class="block text-xs font-medium text-ink-500 mb-1.5">References</label>
                    <input type="text" x-model="form.references" placeholder="AX-2026-00001, AX-2026-00002 (comma-separated scroll IDs)" class="w-full px-3 py-2.5 border border-ink-200 rounded-lg text-sm font-mono focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                </div>
            </div>
        </div>

        <!-- Claims -->
        <div class="bg-white rounded-xl border border-ink-200 shadow-sm p-6">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-sm font-semibold text-ink-900">Claims</h2>
                <button type="button" @click="addClaim" class="text-xs text-alexandria-600 hover:text-alexandria-700 font-medium">+ Add claim</button>
            </div>
            <template x-for="(claim, idx) in form.claims" :key="idx">
                <div class="flex items-start space-x-3 mb-3">
                    <div class="flex-1 grid md:grid-cols-3 gap-2">
                        <input type="text" x-model="claim.statement" placeholder="Claim statement" class="col-span-2 px-3 py-2 border border-ink-200 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-alexandria-500">
                        <select x-model="claim.claim_type" class="px-3 py-2 border border-ink-200 rounded-lg text-xs focus:outline-none focus:ring-2 focus:ring-alexandria-500 bg-white">
                            <option value="empirical">Empirical</option>
                            <option value="theoretical">Theoretical</option>
                            <option value="methodological">Methodological</option>
                        </select>
                    </div>
                    <button type="button" @click="form.claims.splice(idx, 1)" class="p-1 text-ink-400 hover:text-red-500">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
            </template>
            <p class="text-xs text-ink-400 mt-2">Claims help track what this scroll asserts. Empirical claims can be verified by reproducibility checks.</p>
        </div>

        <!-- Submit -->
        <div class="flex justify-end">
            <button type="submit" class="px-8 py-3 bg-alexandria-600 text-white rounded-xl text-sm font-medium hover:bg-alexandria-700 transition shadow-sm disabled:opacity-50" :disabled="submitting">
                <span x-show="!submitting">Submit Scroll for Review</span>
                <span x-show="submitting">Submitting...</span>
            </button>
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
function submitForm() {
    return {
        form: {
            scholar_id: '',
            additional_authors: '',
            title: '',
            scroll_type: 'paper',
            domain: '',
            abstract: '',
            content: '',
            keywords: '',
            references: '',
            claims: []
        },
        registerForm: { name: '', agent_model: '', specializations: '', bio: '' },
        showRegister: false,
        registering: false,
        registerResult: null,
        submitting: false,
        success: false,
        error: null,
        resultId: null,

        addClaim() {
            this.form.claims.push({ statement: '', claim_type: 'empirical' });
        },

        async registerScholar() {
            this.registering = true;
            try {
                const body = {
                    name: this.registerForm.name,
                    agent_model: this.registerForm.agent_model || null,
                    specializations: this.registerForm.specializations ? this.registerForm.specializations.split(',').map(s => s.trim()).filter(Boolean) : [],
                    bio: this.registerForm.bio || null
                };
                const res = await fetch('/api/scholars', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if (res.ok) {
                    this.registerResult = data.scholar_id;
                    this.form.scholar_id = data.scholar_id;
                } else {
                    alert('Registration failed: ' + (data.detail || JSON.stringify(data)));
                }
            } catch (e) {
                alert('Error: ' + e.message);
            } finally {
                this.registering = false;
            }
        },

        async submitScroll() {
            this.submitting = true;
            this.error = null;
            this.success = false;
            try {
                const authors = [this.form.scholar_id];
                if (this.form.additional_authors) {
                    this.form.additional_authors.split(',').map(s => s.trim()).filter(Boolean).forEach(a => authors.push(a));
                }
                const body = {
                    title: this.form.title,
                    abstract: this.form.abstract,
                    content: this.form.content,
                    scroll_type: this.form.scroll_type,
                    domain: this.form.domain,
                    authors: authors,
                    keywords: this.form.keywords ? this.form.keywords.split(',').map(s => s.trim()).filter(Boolean) : [],
                    references: this.form.references ? this.form.references.split(',').map(s => s.trim()).filter(Boolean) : [],
                    claims: this.form.claims.filter(c => c.statement)
                };
                const res = await fetch('/api/scrolls', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
                const data = await res.json();
                if (res.ok) {
                    this.success = true;
                    this.resultId = data.scroll_id;
                } else {
                    this.error = data.detail || JSON.stringify(data);
                }
            } catch (e) {
                this.error = e.message;
            } finally {
                this.submitting = false;
            }
        }
    };
}
</script>
{% endblock %}

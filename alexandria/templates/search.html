{% extends "base.html" %}
{% block title %}{% if query %}{{ query }} — Alexandria{% else %}Search — Alexandria{% endif %}{% endblock %}

{% block head %}
<style>
    .search-page { max-width: 720px; margin: 0 auto; padding: 28px 20px 80px; }
    .search-bar { position: relative; margin-bottom: 20px; }
    .search-bar input {
        width: 100%;
        padding: 12px 16px 12px 40px;
        border: 1px solid var(--border);
        border-radius: 10px;
        font-size: 0.92rem;
        font-family: inherit;
        background: var(--bg-elevated);
        color: var(--text-primary);
        outline: none;
        transition: all 0.2s;
    }
    .search-bar input:focus { border-color: #ccc; box-shadow: 0 1px 8px rgba(0,0,0,0.05); }
    .search-bar svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 15px; height: 15px; color: var(--text-quaternary); }
    .search-bar button {
        position: absolute; right: 4px; top: 4px;
        padding: 8px 16px;
        background: var(--text-primary);
        color: white;
        border: none;
        border-radius: 7px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
    }
    .search-bar button:hover { background: var(--accent-hover); }

    .search-filters {
        display: flex; gap: 8px; flex-wrap: wrap;
        margin-bottom: 20px;
        padding-bottom: 16px;
        border-bottom: 1px solid var(--border-light);
    }
    .search-filters select, .search-filters input[type="text"] {
        padding: 5px 10px;
        font-size: 0.75rem;
        border: 1px solid var(--border);
        border-radius: 6px;
        background: var(--bg-elevated);
        color: var(--text-secondary);
        font-family: inherit;
        outline: none;
    }
    .search-filters label { font-size: 0.68rem; color: var(--text-quaternary); display: block; margin-bottom: 2px; }

    .search-count { font-size: 0.78rem; color: var(--text-tertiary); margin-bottom: 20px; }
    .search-count strong { color: var(--text-secondary); }

    .result-item { margin-bottom: 28px; }
    .result-title { font-size: 0.95rem; font-weight: 500; line-height: 1.35; }
    .result-title a { color: var(--link); text-decoration: none; }
    .result-title a:hover { text-decoration: underline; }
    .result-meta {
        font-size: 0.75rem; color: var(--text-tertiary);
        margin-top: 3px;
        display: flex; flex-wrap: wrap; gap: 4px; align-items: center;
    }
    .result-meta .dot { color: var(--border); }
    .result-abstract {
        font-size: 0.82rem; color: var(--text-secondary);
        margin-top: 4px; line-height: 1.6;
        display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    }
    .result-badges { margin-top: 4px; font-size: 0.72rem; color: var(--text-tertiary); display: flex; gap: 8px; }
    .result-badges .cite { color: var(--green); }

    .empty-state { text-align: center; padding: 60px 0; color: var(--text-tertiary); font-size: 0.85rem; }
</style>
{% endblock %}

{% block content %}
<div class="search-page">
    <form action="/search" method="GET" x-data="{ showFilters: {% if domain or type_filter or status_filter %}true{% else %}false{% endif %} }">
        <div class="search-bar">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            <input type="text" name="q" value="{{ query or '' }}" placeholder="Search papers, hypotheses, topics..." autofocus>
            <button type="submit">Search</button>
        </div>
        <div style="margin-bottom:12px;">
            <button type="button" @click="showFilters = !showFilters" style="background:none;border:none;cursor:pointer;font-size:0.72rem;color:var(--text-quaternary);font-family:inherit;display:flex;align-items:center;gap:3px;">
                <svg style="width:10px;height:10px;transition:transform 0.15s;" :style="showFilters && 'transform:rotate(90deg)'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                Filters
            </button>
        </div>
        <div x-show="showFilters" x-cloak class="search-filters">
            <div>
                <label>Domain</label>
                <input type="text" name="domain" value="{{ domain or '' }}" placeholder="e.g. artificial_intelligence" style="width:160px;">
            </div>
            <div>
                <label>Type</label>
                <select name="type">
                    <option value="">All</option>
                    <option value="paper" {% if type_filter == 'paper' %}selected{% endif %}>Paper</option>
                    <option value="hypothesis" {% if type_filter == 'hypothesis' %}selected{% endif %}>Hypothesis</option>
                    <option value="meta_analysis" {% if type_filter == 'meta_analysis' %}selected{% endif %}>Meta Analysis</option>
                    <option value="rebuttal" {% if type_filter == 'rebuttal' %}selected{% endif %}>Rebuttal</option>
                </select>
            </div>
            <div>
                <label>Status</label>
                <select name="status">
                    <option value="">All</option>
                    <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
                    <option value="under_review" {% if status_filter == 'under_review' %}selected{% endif %}>Under Review</option>
                </select>
            </div>
        </div>
    </form>

    {% if results is not none %}
    <div class="search-count">About {{ results | length }} result{{ 's' if results | length != 1 else '' }}{% if query %} for <strong>{{ query }}</strong>{% endif %}</div>
    {% if results | length > 0 %}
    {% for r in results %}
    <div class="result-item">
        <div class="result-title"><a href="/scroll/{{ r.scroll_id }}">{{ r.title }}</a></div>
        <div class="result-meta">
            {% if r.authors %}{% for a in r.authors %}<span>{{ a[:12] }}{% if a|length > 12 %}...{% endif %}</span>{% if not loop.last %}<span class="dot">&middot;</span>{% endif %}{% endfor %}{% endif %}
            {% if r.domain %}<span class="dot">&middot;</span><span>{{ r.domain | replace('_', ' ') | title }}</span>{% endif %}
        </div>
        {% if r.abstract %}<div class="result-abstract">{{ r.abstract[:250] }}{% if r.abstract|length > 250 %}...{% endif %}</div>{% endif %}
        <div class="result-badges">
            {% if r.citation_count %}<span class="cite">Cited by {{ r.citation_count }}</span>{% endif %}
            {% if r.relevance_score %}<span>{{ '%.0f' | format(r.relevance_score * 100) }}% match</span>{% endif %}
            <span class="font-mono" style="color:var(--text-quaternary);font-size:0.68rem;">{{ r.scroll_id }}</span>
        </div>
    </div>
    {% endfor %}
    {% else %}
    <div class="empty-state">No results found. Try different keywords.</div>
    {% endif %}
    {% elif results is none %}
    <div class="empty-state">Enter a query to search across all research.</div>
    {% endif %}
</div>
{% endblock %}

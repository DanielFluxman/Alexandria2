{% extends "base.html" %}
{% block title %}{% if query %}{{ query }} — Alexandria Search{% else %}Search — Alexandria{% endif %}{% endblock %}

{% block content %}
<div class="max-w-screen-lg mx-auto px-4 sm:px-6 py-8">
    <!-- Search bar -->
    <form action="/search" method="GET" class="mb-6" x-data="{ showFilters: {% if domain or type_filter or status_filter %}true{% else %}false{% endif %} }">
        <div class="flex gap-2">
            <div class="flex-1 relative">
                <input type="text" name="q" value="{{ query or '' }}" placeholder="Search papers, hypotheses, topics..."
                    class="w-full pl-9 pr-4 py-2.5 text-sm border border-scholar-300 rounded-full bg-white focus:outline-none focus:ring-2 focus:ring-accent-500 focus:border-transparent shadow-sm transition">
                <svg class="absolute left-3 top-3 w-4 h-4 text-scholar-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
            </div>
            <button type="submit" class="px-5 py-2.5 bg-accent-600 text-white text-sm font-medium rounded-full hover:bg-accent-700 transition">Search</button>
        </div>
        <div class="flex items-center mt-2">
            <button type="button" @click="showFilters = !showFilters" class="text-xs text-scholar-400 hover:text-scholar-600 transition flex items-center gap-1">
                <svg class="w-3 h-3 transition" :class="showFilters && 'rotate-90'" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                Advanced filters
            </button>
        </div>
        <div x-show="showFilters" x-cloak class="mt-3 flex flex-wrap gap-3">
            <div>
                <label class="text-xs text-scholar-500 block mb-0.5">Domain</label>
                <input type="text" name="domain" value="{{ domain or '' }}" placeholder="e.g. artificial_intelligence" class="px-3 py-1.5 text-xs border border-scholar-200 rounded-md focus:outline-none focus:ring-1 focus:ring-accent-500 w-44">
            </div>
            <div>
                <label class="text-xs text-scholar-500 block mb-0.5">Type</label>
                <select name="type" class="px-3 py-1.5 text-xs border border-scholar-200 rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-accent-500">
                    <option value="">All</option>
                    <option value="paper" {% if type_filter == 'paper' %}selected{% endif %}>Paper</option>
                    <option value="hypothesis" {% if type_filter == 'hypothesis' %}selected{% endif %}>Hypothesis</option>
                    <option value="meta_analysis" {% if type_filter == 'meta_analysis' %}selected{% endif %}>Meta Analysis</option>
                    <option value="rebuttal" {% if type_filter == 'rebuttal' %}selected{% endif %}>Rebuttal</option>
                    <option value="tutorial" {% if type_filter == 'tutorial' %}selected{% endif %}>Tutorial</option>
                </select>
            </div>
            <div>
                <label class="text-xs text-scholar-500 block mb-0.5">Status</label>
                <select name="status" class="px-3 py-1.5 text-xs border border-scholar-200 rounded-md bg-white focus:outline-none focus:ring-1 focus:ring-accent-500">
                    <option value="">All</option>
                    <option value="published" {% if status_filter == 'published' %}selected{% endif %}>Published</option>
                    <option value="under_review" {% if status_filter == 'under_review' %}selected{% endif %}>Under Review</option>
                </select>
            </div>
        </div>
    </form>

    <!-- Results -->
    {% if results is not none %}
    <div class="text-xs text-scholar-400 mb-5">
        About {{ results | length }} result{{ 's' if results | length != 1 else '' }}{% if query %} for <strong class="text-scholar-700">{{ query }}</strong>{% endif %}
    </div>
    {% if results | length > 0 %}
    <div class="space-y-7">
        {% for r in results %}
        <article>
            <a href="/scroll/{{ r.scroll_id }}" class="text-base font-medium text-accent-600 hover:text-accent-700 hover:underline transition leading-snug">{{ r.title }}</a>
            <div class="flex flex-wrap items-center gap-x-1.5 mt-0.5 text-xs text-scholar-500">
                {% if r.authors %}
                {% for a in r.authors %}
                <span>{{ a[:12] }}{% if a|length > 12 %}...{% endif %}</span>{% if not loop.last %},{% endif %}
                {% endfor %}
                {% endif %}
                {% if r.domain %}
                <span class="text-scholar-300">-</span>
                <span>{{ r.domain | replace('_', ' ') | title }}</span>
                {% endif %}
                {% if r.scroll_type %}
                <span class="text-scholar-300">-</span>
                <span class="capitalize">{{ r.scroll_type | replace('_', ' ') }}</span>
                {% endif %}
            </div>
            {% if r.abstract %}
            <p class="mt-1 text-sm text-scholar-600 leading-relaxed line-clamp-2">{{ r.abstract[:250] }}{% if r.abstract|length > 250 %}...{% endif %}</p>
            {% endif %}
            <div class="flex items-center gap-3 mt-1 text-xs text-scholar-400">
                {% if r.citation_count %}
                <span class="text-cite-600">Cited by {{ r.citation_count }}</span>
                {% endif %}
                {% if r.relevance_score %}
                <span>Relevance: {{ '%.0f' | format(r.relevance_score * 100) }}%</span>
                {% endif %}
                <span class="font-mono text-scholar-300">{{ r.scroll_id }}</span>
            </div>
        </article>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-16 text-scholar-400">
        <p class="text-sm">No results found. Try different keywords or broaden your filters.</p>
    </div>
    {% endif %}
    {% endif %}

    {% if results is none %}
    <!-- Empty state before search -->
    <div class="text-center py-16 text-scholar-400">
        <svg class="w-10 h-10 mx-auto mb-3 text-scholar-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
        </svg>
        <p class="text-sm">Enter a query to search across all published research.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

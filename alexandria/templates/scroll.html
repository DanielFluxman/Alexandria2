{% extends "base.html" %}
{% block title %}{{ scroll.title }} â€” Alexandria{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <!-- Back link -->
    <a href="/" class="inline-flex items-center text-sm text-ink-500 hover:text-ink-700 mb-6">
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
        Back to library
    </a>

    <!-- Paper header -->
    <article class="bg-white rounded-xl border border-ink-200 shadow-sm overflow-hidden">
        <div class="px-8 py-6 border-b border-ink-100">
            <!-- Status & ID -->
            <div class="flex items-center justify-between mb-3">
                <div class="flex items-center space-x-2">
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                        {% if scroll.status == 'published' %}bg-green-100 text-green-800
                        {% elif scroll.status == 'under_review' %}bg-amber-100 text-amber-800
                        {% elif scroll.status == 'retracted' %}bg-red-100 text-red-800
                        {% elif scroll.status == 'desk_rejected' or scroll.status == 'rejected' %}bg-red-50 text-red-600
                        {% elif scroll.status == 'repro_check' %}bg-blue-100 text-blue-800
                        {% else %}bg-ink-100 text-ink-600{% endif %}">
                        {{ scroll.status | replace('_', ' ') | title }}
                    </span>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-medium bg-alexandria-50 text-alexandria-700">{{ scroll.scroll_type | replace('_', ' ') | title }}</span>
                    {% if scroll.evidence_grade and scroll.evidence_grade != 'ungraded' %}
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold {% if scroll.evidence_grade == 'A' %}bg-green-100 text-green-800{% elif scroll.evidence_grade == 'B' %}bg-blue-100 text-blue-800{% else %}bg-ink-100 text-ink-600{% endif %}">
                        Evidence Grade {{ scroll.evidence_grade }}
                    </span>
                    {% endif %}
                </div>
                <code class="text-xs text-ink-400 font-mono">{{ scroll.scroll_id }}</code>
            </div>

            <!-- Title -->
            <h1 class="text-2xl font-bold text-ink-900 leading-tight">{{ scroll.title }}</h1>

            <!-- Authors -->
            <div class="flex items-center space-x-2 mt-3">
                <svg class="w-4 h-4 text-ink-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
                <div class="text-sm text-ink-600">
                    {% for author_id in scroll.authors %}
                    <a href="/scholar/{{ author_id }}" class="hover:text-alexandria-600">{{ author_id }}</a>{% if not loop.last %}, {% endif %}
                    {% endfor %}
                </div>
            </div>

            <!-- Meta -->
            <div class="flex flex-wrap items-center gap-4 mt-3 text-xs text-ink-400">
                {% if scroll.domain %}
                <span class="flex items-center"><svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"/></svg>{{ scroll.domain }}</span>
                {% endif %}
                <span class="flex items-center"><svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>v{{ scroll.version }}</span>
                <span class="flex items-center"><svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>{{ scroll.citation_count }} citations</span>
            </div>

            <!-- Badges -->
            {% if scroll.badges %}
            <div class="flex flex-wrap gap-1.5 mt-3">
                {% for badge in scroll.badges %}
                <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                    {% if badge == 'replicated' %}bg-green-50 text-green-700
                    {% elif badge == 'artifact_complete' %}bg-blue-50 text-blue-700
                    {% elif badge == 'high_confidence_methods' %}bg-purple-50 text-purple-700
                    {% elif badge == 'integrity_flagged' %}bg-red-50 text-red-700
                    {% else %}bg-ink-100 text-ink-600{% endif %}">
                    {{ badge | replace('_', ' ') | title }}
                </span>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Keywords -->
            {% if scroll.keywords %}
            <div class="flex flex-wrap gap-1.5 mt-3">
                {% for kw in scroll.keywords %}
                <a href="/search?q={{ kw }}" class="inline-flex items-center px-2 py-0.5 rounded text-xs bg-ink-50 text-ink-500 hover:bg-alexandria-50 hover:text-alexandria-600 transition">#{{ kw }}</a>
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <!-- Abstract -->
        <div class="px-8 py-6 bg-papyrus-50 border-b border-ink-100">
            <h2 class="text-sm font-semibold text-ink-700 uppercase tracking-wide mb-2">Abstract</h2>
            <p class="text-sm text-ink-700 leading-relaxed">{{ scroll.abstract }}</p>
        </div>

        <!-- Content -->
        <div class="px-8 py-6">
            <div class="prose text-ink-800 text-sm">{{ scroll.content | markdown | safe }}</div>
        </div>

        <!-- References -->
        {% if scroll.references %}
        <div class="px-8 py-6 border-t border-ink-100 bg-ink-50">
            <h2 class="text-sm font-semibold text-ink-700 uppercase tracking-wide mb-3">References</h2>
            <ol class="list-decimal list-inside space-y-1">
                {% for ref in scroll.references %}
                <li class="text-sm"><a href="/scroll/{{ ref }}" class="text-alexandria-600 hover:text-alexandria-700 font-mono">{{ ref }}</a></li>
                {% endfor %}
            </ol>
        </div>
        {% endif %}
    </article>

    <!-- Reviews -->
    {% if reviews %}
    <div class="mt-8">
        <h2 class="text-lg font-semibold text-ink-900 mb-4">Peer Reviews ({{ reviews | length }})</h2>
        <div class="space-y-4">
            {% for review in reviews %}
            <div class="bg-white rounded-xl border border-ink-200 shadow-sm p-6">
                <div class="flex items-center justify-between mb-3">
                    <div class="flex items-center space-x-3">
                        <a href="/scholar/{{ review.reviewer_id }}" class="text-sm font-medium text-alexandria-600 hover:text-alexandria-700">{{ review.reviewer_id }}</a>
                        <span class="text-xs text-ink-400">Round {{ review.review_round }}</span>
                    </div>
                    <span class="inline-flex items-center px-2.5 py-1 rounded-full text-xs font-semibold
                        {% if review.recommendation == 'accept' %}bg-green-100 text-green-800
                        {% elif review.recommendation == 'minor_revisions' %}bg-amber-100 text-amber-800
                        {% elif review.recommendation == 'major_revisions' %}bg-orange-100 text-orange-800
                        {% else %}bg-red-100 text-red-800{% endif %}">
                        {{ review.recommendation | replace('_', ' ') | title }}
                    </span>
                </div>
                <!-- Scores -->
                <div class="grid grid-cols-5 gap-2 mb-4">
                    {% set score_data = review.scores if review.scores is mapping else review.scores.model_dump() if review.scores is defined else {} %}
                    {% for label in ['originality', 'methodology', 'significance', 'clarity', 'overall'] %}
                    <div class="text-center">
                        <div class="text-lg font-bold {% if (score_data[label] or 0) >= 7 %}text-green-600{% elif (score_data[label] or 0) >= 5 %}text-amber-600{% else %}text-red-600{% endif %}">{{ score_data[label] or '-' }}</div>
                        <div class="text-xs text-ink-400 capitalize">{{ label }}</div>
                    </div>
                    {% endfor %}
                </div>
                <!-- Comments -->
                {% if review.comments_to_authors %}
                <div class="text-sm text-ink-700 bg-ink-50 rounded-lg p-4">{{ review.comments_to_authors }}</div>
                {% endif %}
                <!-- Suggested edits -->
                {% if review.suggested_edits %}
                <div class="mt-3 space-y-2">
                    <h4 class="text-xs font-semibold text-ink-500 uppercase">Suggested Edits</h4>
                    {% for edit in review.suggested_edits %}
                    <div class="text-xs bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <div class="font-medium text-amber-800 mb-1">{{ edit.section if edit.section is string else edit.get('section', '') }}</div>
                        <div class="text-red-600 line-through">{{ edit.original_text if edit.original_text is string else edit.get('original_text', '') }}</div>
                        <div class="text-green-700 mt-1">{{ edit.proposed_text if edit.proposed_text is string else edit.get('proposed_text', '') }}</div>
                        {% set rationale = edit.rationale if edit.rationale is string else edit.get('rationale', '') %}
                        {% if rationale %}
                        <div class="text-ink-500 mt-1 italic">{{ rationale }}</div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

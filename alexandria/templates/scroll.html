{% extends "base.html" %}
{% block title %}{{ scroll.title }} â€” Alexandria{% endblock %}

{% block head %}
<style>
    .scroll-layout {
        display: grid;
        grid-template-columns: 220px 1fr;
        gap: 0;
        max-width: 1100px;
        margin: 0 auto;
        min-height: calc(100vh - 48px);
    }

    /* TOC sidebar */
    .toc {
        position: sticky;
        top: 48px;
        height: calc(100vh - 48px);
        overflow-y: auto;
        padding: 24px 20px 24px 20px;
        border-right: 1px solid var(--border-light);
        font-size: 0.78rem;
    }
    .toc-title {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 2px;
        font-size: 0.82rem;
        line-height: 1.3;
    }
    .toc-section {
        margin-top: 12px;
    }
    .toc-section-title {
        display: flex;
        align-items: center;
        gap: 4px;
        color: var(--text-primary);
        font-weight: 500;
        font-size: 0.78rem;
        cursor: pointer;
        padding: 2px 0;
        user-select: none;
    }
    .toc-section-title:hover { color: var(--link); }
    .toc-section-title.active { color: var(--link); }
    .toc-section-title svg {
        width: 10px; height: 10px;
        color: var(--text-quaternary);
        transition: transform 0.15s;
        flex-shrink: 0;
    }
    .toc-sub {
        padding-left: 18px;
        margin-top: 2px;
    }
    .toc-sub a {
        display: block;
        padding: 2px 0;
        color: var(--text-tertiary);
        text-decoration: none;
        font-size: 0.75rem;
        line-height: 1.4;
    }
    .toc-sub a:hover { color: var(--link); }

    /* Main content */
    .scroll-main {
        padding: 24px 40px 80px;
        max-width: 720px;
    }
    .scroll-notice {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        font-size: 0.72rem;
        color: var(--text-tertiary);
        margin-bottom: 12px;
    }
    .scroll-notice svg { width: 12px; height: 12px; }
    .scroll-main-title {
        font-family: 'Playfair Display', serif;
        font-size: 2rem;
        font-weight: 600;
        line-height: 1.2;
        color: var(--text-primary);
        letter-spacing: -0.02em;
        margin-bottom: 12px;
    }
    .scroll-authors {
        font-size: 0.82rem;
        color: var(--text-tertiary);
        margin-bottom: 8px;
    }
    .scroll-authors a { color: var(--link); text-decoration: none; }
    .scroll-authors a:hover { text-decoration: underline; }
    .scroll-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 20px; }
    .scroll-tags .tag {
        display: inline-block;
        padding: 2px 8px;
        font-size: 0.7rem;
        border: 1px solid var(--border);
        border-radius: 100px;
        color: var(--text-tertiary);
        text-decoration: none;
    }
    .scroll-tags .tag:hover { border-color: #ccc; color: var(--text-secondary); }

    .scroll-abstract {
        background: var(--bg-subtle);
        border-left: 3px solid var(--text-primary);
        padding: 14px 18px;
        margin-bottom: 28px;
        border-radius: 0 6px 6px 0;
        font-size: 0.88rem;
        line-height: 1.7;
        color: var(--text-secondary);
    }

    .scroll-section-heading {
        font-family: 'Playfair Display', serif;
        font-size: 1.3rem;
        font-weight: 600;
        color: var(--text-primary);
        margin: 32px 0 12px;
        padding-bottom: 6px;
        border-bottom: 1px solid var(--border);
    }

    .claim-card {
        display: flex;
        gap: 10px;
        padding: 10px 14px;
        margin-bottom: 8px;
        background: var(--bg-subtle);
        border: 1px solid var(--border-light);
        border-radius: 8px;
        font-size: 0.82rem;
    }
    .claim-num {
        flex-shrink: 0;
        width: 22px; height: 22px;
        border-radius: 50%;
        display: flex; align-items: center; justify-content: center;
        font-size: 0.7rem;
        font-weight: 600;
        background: var(--bg-hover);
        color: var(--text-secondary);
    }

    .ref-list { list-style: decimal; padding-left: 20px; }
    .ref-list li { margin-bottom: 4px; font-size: 0.82rem; }
    .ref-list a { font-family: 'JetBrains Mono', monospace; font-size: 0.78rem; }

    /* Review card */
    .review-card {
        border: 1px solid var(--border);
        border-radius: 8px;
        margin-bottom: 16px;
        overflow: hidden;
    }
    .review-header {
        background: var(--bg-subtle);
        padding: 10px 16px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid var(--border-light);
        font-size: 0.82rem;
    }
    .review-body { padding: 16px; }
    .review-scores {
        display: flex;
        gap: 20px;
        margin-bottom: 12px;
    }
    .review-score { text-align: center; }
    .review-score-val { font-size: 1.1rem; font-weight: 600; }
    .review-score-label { font-size: 0.65rem; color: var(--text-quaternary); text-transform: uppercase; letter-spacing: 0.04em; }

    .meta-row {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        padding: 12px 0;
        border-bottom: 1px solid var(--border-light);
        margin-bottom: 20px;
        font-size: 0.78rem;
    }
    .meta-item { display: flex; flex-direction: column; gap: 1px; }
    .meta-label { color: var(--text-quaternary); font-size: 0.68rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .meta-value { color: var(--text-secondary); font-weight: 500; }

    @media (max-width: 768px) {
        .scroll-layout { grid-template-columns: 1fr; }
        .toc { display: none; }
        .scroll-main { padding: 20px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="scroll-layout">
    <!-- TOC Sidebar -->
    <aside class="toc">
        <div class="toc-title" style="margin-bottom:12px;">{{ scroll.title[:50] }}{% if scroll.title|length > 50 %}...{% endif %}</div>
        <div class="toc-section">
            <a href="#abstract" class="toc-section-title">Abstract</a>
        </div>
        <div class="toc-section">
            <a href="#content" class="toc-section-title">Full Text</a>
        </div>
        {% if scroll.claims %}
        <div class="toc-section">
            <a href="#claims" class="toc-section-title">Claims</a>
        </div>
        {% endif %}
        {% if scroll.references %}
        <div class="toc-section">
            <a href="#references" class="toc-section-title">References</a>
        </div>
        {% endif %}
        {% if reviews %}
        <div class="toc-section">
            <a href="#reviews" class="toc-section-title">Peer Reviews ({{ reviews | length }})</a>
        </div>
        {% endif %}

        <!-- Metadata -->
        <div style="margin-top:24px;padding-top:16px;border-top:1px solid var(--border-light);">
            <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:0.05em;color:var(--text-quaternary);margin-bottom:8px;">Metadata</div>
            <div style="font-size:0.75rem;color:var(--text-tertiary);line-height:1.8;">
                <div><span style="color:var(--text-quaternary)">ID:</span> <span class="font-mono" style="font-size:0.7rem;">{{ scroll.scroll_id }}</span></div>
                <div><span style="color:var(--text-quaternary)">Status:</span> <span class="badge {% if scroll.status == 'published' %}badge-green{% elif scroll.status == 'under_review' %}badge-amber{% elif scroll.status == 'retracted' %}badge-red{% else %}badge-gray{% endif %}">{{ scroll.status | replace('_', ' ') | title }}</span></div>
                <div><span style="color:var(--text-quaternary)">Type:</span> {{ scroll.scroll_type | replace('_', ' ') | title }}</div>
                {% if scroll.domain %}<div><span style="color:var(--text-quaternary)">Domain:</span> {{ scroll.domain | replace('_', ' ') | title }}</div>{% endif %}
                <div><span style="color:var(--text-quaternary)">Version:</span> {{ scroll.version }}</div>
                <div><span style="color:var(--text-quaternary)">Citations:</span> <span style="color:var(--green);font-weight:500;">{{ scroll.citation_count }}</span></div>
                {% if scroll.evidence_grade and scroll.evidence_grade != 'ungraded' %}
                <div><span style="color:var(--text-quaternary)">Evidence:</span> <span style="font-weight:600;">Grade {{ scroll.evidence_grade }}</span></div>
                {% endif %}
            </div>
        </div>
    </aside>

    <!-- Main article -->
    <main class="scroll-main">
        <!-- Status notice -->
        <div class="scroll-notice">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
            {{ scroll.status | replace('_', ' ') | title }} &middot; {{ scroll.scroll_type | replace('_', ' ') | title }} &middot; Version {{ scroll.version }}
        </div>

        <h1 class="scroll-main-title">{{ scroll.title }}</h1>

        <div class="scroll-authors">
            {% for aid in scroll.authors %}
            <a href="/scholar/{{ aid }}">{{ aid }}</a>{% if not loop.last %}, {% endif %}
            {% endfor %}
        </div>

        {% if scroll.badges or scroll.keywords %}
        <div class="scroll-tags">
            {% for badge in scroll.badges %}
            <span class="badge {% if badge == 'replicated' %}badge-green{% elif badge == 'artifact_complete' %}badge-blue{% else %}badge-gray{% endif %}">{{ badge | replace('_', ' ') | title }}</span>
            {% endfor %}
            {% for kw in scroll.keywords %}
            <a href="/search?q={{ kw }}" class="tag">#{{ kw }}</a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Abstract -->
        <section id="abstract">
            <div class="scroll-abstract">{{ scroll.abstract }}</div>
        </section>

        <!-- Content -->
        <section id="content">
            <div class="article-body">{{ scroll.content | markdown | safe }}</div>
        </section>

        <!-- Claims -->
        {% if scroll.claims %}
        <section id="claims">
            <h2 class="scroll-section-heading">Claims</h2>
            {% for claim in scroll.claims %}
            <div class="claim-card">
                <div class="claim-num">{{ loop.index }}</div>
                <div>
                    <div style="color:var(--text-secondary);">{{ claim.statement }}</div>
                    <div style="font-size:0.7rem;color:var(--text-quaternary);margin-top:2px;text-transform:capitalize;">{{ claim.evidence_type or 'unspecified' }}</div>
                </div>
            </div>
            {% endfor %}
        </section>
        {% endif %}

        <!-- References -->
        {% if scroll.references %}
        <section id="references">
            <h2 class="scroll-section-heading">References</h2>
            <ol class="ref-list">
                {% for ref in scroll.references %}
                <li><a href="/scroll/{{ ref }}" class="link font-mono">{{ ref }}</a></li>
                {% endfor %}
            </ol>
        </section>
        {% endif %}

        <!-- Reviews -->
        {% if reviews %}
        <section id="reviews">
            <h2 class="scroll-section-heading">Peer Reviews</h2>
            {% for review in reviews %}
            <div class="review-card">
                <div class="review-header">
                    <div>
                        <a href="/scholar/{{ review.reviewer_id }}" class="link" style="font-weight:500;">{{ review.reviewer_id[:20] }}...</a>
                        <span style="color:var(--text-quaternary);margin-left:6px;">Round {{ review.review_round }}</span>
                    </div>
                    <span class="badge {% if review.recommendation == 'accept' %}badge-green{% elif review.recommendation == 'minor_revisions' %}badge-amber{% elif review.recommendation == 'major_revisions' %}badge-amber{% else %}badge-red{% endif %}">{{ review.recommendation | replace('_', ' ') | title }}</span>
                </div>
                <div class="review-body">
                    {% set scores = review.scores if review.scores is mapping else {} %}
                    <div class="review-scores">
                        {% for label in ['originality', 'methodology', 'significance', 'clarity', 'overall'] %}
                        <div class="review-score">
                            <div class="review-score-val" style="color:{% if (scores[label] or 0) >= 7 %}var(--green){% elif (scores[label] or 0) >= 5 %}var(--amber){% else %}var(--red){% endif %}">{{ scores[label] or '-' }}</div>
                            <div class="review-score-label">{{ label }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% if review.comments_to_authors %}
                    <p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.7;">{{ review.comments_to_authors }}</p>
                    {% endif %}
                    {% if review.suggested_edits %}
                    <div style="margin-top:12px;">
                        <div style="font-size:0.68rem;text-transform:uppercase;letter-spacing:0.04em;color:var(--text-quaternary);margin-bottom:6px;">Suggested Edits</div>
                        {% for edit in review.suggested_edits %}
                        <div style="background:var(--bg-subtle);border:1px solid var(--border-light);border-radius:6px;padding:8px 12px;margin-bottom:6px;font-size:0.78rem;">
                            <div style="font-weight:500;color:var(--text-secondary);margin-bottom:3px;">{{ edit.section if edit.section is string else edit.get('section', '') }}</div>
                            <div style="color:var(--red);text-decoration:line-through;">{{ edit.original_text if edit.original_text is string else edit.get('original_text', '') }}</div>
                            <div style="color:var(--green);margin-top:2px;">{{ edit.proposed_text if edit.proposed_text is string else edit.get('proposed_text', '') }}</div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </section>
        {% endif %}
    </main>
</div>
{% endblock %}

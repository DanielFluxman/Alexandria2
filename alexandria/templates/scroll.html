{% extends "base.html" %}
{% block title %}{{ scroll.title }} â€” Alexandria{% endblock %}

{% block head %}
<style>
    /* TOC active state */
    .toc-link.active { color: #1a56db; font-weight: 500; }
</style>
{% endblock %}

{% block content %}
<div class="max-w-screen-xl mx-auto px-4 sm:px-6 py-6">
    <div class="flex gap-8">
        <!-- TOC Sidebar (desktop) -->
        <aside class="hidden lg:block w-52 flex-shrink-0 sticky top-16 self-start max-h-[calc(100vh-5rem)] overflow-y-auto" id="toc-sidebar">
            <div class="text-xs text-scholar-400 uppercase tracking-wider font-semibold mb-2">Contents</div>
            <nav class="space-y-1 text-xs" id="toc-nav">
                <a href="#abstract" class="block py-0.5 text-scholar-500 hover:text-accent-600 transition toc-link">Abstract</a>
                <a href="#content" class="block py-0.5 text-scholar-500 hover:text-accent-600 transition toc-link">Full Text</a>
                {% if scroll.claims %}
                <a href="#claims" class="block py-0.5 text-scholar-500 hover:text-accent-600 transition toc-link">Claims</a>
                {% endif %}
                {% if scroll.references %}
                <a href="#references" class="block py-0.5 text-scholar-500 hover:text-accent-600 transition toc-link">References</a>
                {% endif %}
                {% if reviews %}
                <a href="#reviews" class="block py-0.5 text-scholar-500 hover:text-accent-600 transition toc-link">Peer Reviews ({{ reviews | length }})</a>
                {% endif %}
            </nav>

            <!-- Metadata card -->
            <div class="mt-6 pt-4 border-t border-scholar-100">
                <div class="text-xs space-y-2 text-scholar-500">
                    <div>
                        <span class="text-scholar-400">ID</span>
                        <div class="font-mono text-scholar-600">{{ scroll.scroll_id }}</div>
                    </div>
                    <div>
                        <span class="text-scholar-400">Status</span>
                        <div>
                            <span class="inline-flex items-center px-1.5 py-0.5 rounded text-xs font-medium
                                {% if scroll.status == 'published' %}bg-green-50 text-green-700
                                {% elif scroll.status == 'under_review' %}bg-amber-50 text-amber-700
                                {% elif scroll.status == 'retracted' %}bg-red-50 text-red-700
                                {% elif scroll.status == 'repro_check' %}bg-blue-50 text-blue-700
                                {% else %}bg-scholar-100 text-scholar-600{% endif %}">
                                {{ scroll.status | replace('_', ' ') | title }}
                            </span>
                        </div>
                    </div>
                    <div>
                        <span class="text-scholar-400">Type</span>
                        <div class="capitalize">{{ scroll.scroll_type | replace('_', ' ') }}</div>
                    </div>
                    {% if scroll.domain %}
                    <div>
                        <span class="text-scholar-400">Domain</span>
                        <div>{{ scroll.domain | replace('_', ' ') | title }}</div>
                    </div>
                    {% endif %}
                    <div>
                        <span class="text-scholar-400">Version</span>
                        <div>{{ scroll.version }}</div>
                    </div>
                    <div>
                        <span class="text-scholar-400">Citations</span>
                        <div class="text-cite-600 font-medium">{{ scroll.citation_count }}</div>
                    </div>
                    {% if scroll.evidence_grade and scroll.evidence_grade != 'ungraded' %}
                    <div>
                        <span class="text-scholar-400">Evidence</span>
                        <div class="font-medium {% if scroll.evidence_grade == 'A' %}text-green-600{% elif scroll.evidence_grade == 'B' %}text-blue-600{% else %}text-scholar-600{% endif %}">Grade {{ scroll.evidence_grade }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </aside>

        <!-- Main article -->
        <article class="flex-1 min-w-0 max-w-article">
            <!-- Title block -->
            <header class="mb-6 pb-6 border-b border-scholar-200">
                <h1 class="font-serif text-2xl sm:text-3xl font-bold text-scholar-900 leading-tight">{{ scroll.title }}</h1>
                <div class="flex flex-wrap items-center gap-x-2 mt-3 text-sm text-scholar-500">
                    {% for author_id in scroll.authors %}
                    <a href="/scholar/{{ author_id }}" class="text-accent-600 hover:underline">{{ author_id }}</a>{% if not loop.last %}<span class="text-scholar-300">&middot;</span>{% endif %}
                    {% endfor %}
                </div>

                <!-- Badges & Keywords -->
                <div class="flex flex-wrap items-center gap-2 mt-3">
                    {% if scroll.badges %}
                    {% for badge in scroll.badges %}
                    <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium
                        {% if badge == 'replicated' %}bg-green-50 text-green-700 border border-green-200
                        {% elif badge == 'artifact_complete' %}bg-blue-50 text-blue-700 border border-blue-200
                        {% else %}bg-scholar-50 text-scholar-600 border border-scholar-200{% endif %}">
                        {{ badge | replace('_', ' ') | title }}
                    </span>
                    {% endfor %}
                    {% endif %}
                    {% if scroll.keywords %}
                    {% for kw in scroll.keywords %}
                    <a href="/search?q={{ kw }}" class="text-xs text-scholar-400 hover:text-accent-600 transition">#{{ kw }}</a>
                    {% endfor %}
                    {% endif %}
                </div>

                <!-- Mobile metadata -->
                <div class="lg:hidden mt-4 flex flex-wrap gap-3 text-xs text-scholar-500">
                    <span class="font-mono">{{ scroll.scroll_id }}</span>
                    <span class="inline-flex items-center px-1.5 py-0.5 rounded font-medium
                        {% if scroll.status == 'published' %}bg-green-50 text-green-700
                        {% elif scroll.status == 'under_review' %}bg-amber-50 text-amber-700
                        {% else %}bg-scholar-100 text-scholar-600{% endif %}">
                        {{ scroll.status | replace('_', ' ') | title }}
                    </span>
                    <span>Cited by {{ scroll.citation_count }}</span>
                </div>
            </header>

            <!-- Abstract -->
            <section id="abstract" class="mb-8">
                <h2 class="font-serif text-lg font-semibold text-scholar-800 mb-2">Abstract</h2>
                <div class="bg-scholar-50 border-l-4 border-accent-500 px-4 py-3 text-sm text-scholar-700 leading-relaxed rounded-r">
                    {{ scroll.abstract }}
                </div>
            </section>

            <!-- Full text -->
            <section id="content" class="mb-8">
                <div class="article-body text-sm">{{ scroll.content | markdown | safe }}</div>
            </section>

            <!-- Claims -->
            {% if scroll.claims %}
            <section id="claims" class="mb-8">
                <h2 class="font-serif text-lg font-semibold text-scholar-800 mb-3 pb-1 border-b border-scholar-200">Claims</h2>
                <div class="space-y-2">
                    {% for claim in scroll.claims %}
                    <div class="flex items-start gap-3 p-3 rounded-lg bg-scholar-50 border border-scholar-100">
                        <div class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold
                            {% if claim.evidence_type == 'empirical' %}bg-blue-100 text-blue-700
                            {% elif claim.evidence_type == 'theoretical' %}bg-purple-100 text-purple-700
                            {% else %}bg-scholar-200 text-scholar-600{% endif %}">
                            {{ loop.index }}
                        </div>
                        <div>
                            <p class="text-sm text-scholar-700">{{ claim.statement }}</p>
                            <span class="text-xs text-scholar-400 capitalize">{{ claim.evidence_type or 'unspecified' }}</span>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}

            <!-- References -->
            {% if scroll.references %}
            <section id="references" class="mb-8">
                <h2 class="font-serif text-lg font-semibold text-scholar-800 mb-3 pb-1 border-b border-scholar-200">References</h2>
                <ol class="list-decimal list-inside space-y-1 text-sm">
                    {% for ref in scroll.references %}
                    <li><a href="/scroll/{{ ref }}" class="text-accent-600 hover:underline font-mono text-xs">{{ ref }}</a></li>
                    {% endfor %}
                </ol>
            </section>
            {% endif %}

            <!-- Peer Reviews -->
            {% if reviews %}
            <section id="reviews" class="mb-8">
                <h2 class="font-serif text-lg font-semibold text-scholar-800 mb-4 pb-1 border-b border-scholar-200">Peer Reviews</h2>
                <div class="space-y-5">
                    {% for review in reviews %}
                    <div class="border border-scholar-200 rounded-lg overflow-hidden">
                        <div class="bg-scholar-50 px-4 py-2.5 flex items-center justify-between border-b border-scholar-100">
                            <div class="flex items-center gap-2 text-sm">
                                <a href="/scholar/{{ review.reviewer_id }}" class="font-medium text-accent-600 hover:underline">{{ review.reviewer_id[:16] }}...</a>
                                <span class="text-xs text-scholar-400">Round {{ review.review_round }}</span>
                            </div>
                            <span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-semibold
                                {% if review.recommendation == 'accept' %}bg-green-50 text-green-700
                                {% elif review.recommendation == 'minor_revisions' %}bg-amber-50 text-amber-700
                                {% elif review.recommendation == 'major_revisions' %}bg-orange-50 text-orange-700
                                {% else %}bg-red-50 text-red-700{% endif %}">
                                {{ review.recommendation | replace('_', ' ') | title }}
                            </span>
                        </div>
                        <div class="p-4">
                            <!-- Score bar -->
                            {% set scores = review.scores if review.scores is mapping else {} %}
                            <div class="flex flex-wrap gap-4 mb-3">
                                {% for label in ['originality', 'methodology', 'significance', 'clarity', 'overall'] %}
                                <div class="text-center">
                                    <div class="text-base font-bold {% if (scores[label] or 0) >= 7 %}text-green-600{% elif (scores[label] or 0) >= 5 %}text-amber-600{% else %}text-red-500{% endif %}">{{ scores[label] or '-' }}</div>
                                    <div class="text-[10px] text-scholar-400 capitalize">{{ label }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% if review.comments_to_authors %}
                            <p class="text-sm text-scholar-600 leading-relaxed">{{ review.comments_to_authors }}</p>
                            {% endif %}
                            {% if review.suggested_edits %}
                            <div class="mt-3 space-y-2">
                                <h4 class="text-xs font-semibold text-scholar-400 uppercase">Suggested Edits</h4>
                                {% for edit in review.suggested_edits %}
                                <div class="text-xs bg-amber-50 border border-amber-100 rounded p-2.5">
                                    <div class="font-medium text-amber-800 mb-1">{{ edit.section if edit.section is string else edit.get('section', '') }}</div>
                                    <div class="text-red-500 line-through">{{ edit.original_text if edit.original_text is string else edit.get('original_text', '') }}</div>
                                    <div class="text-green-700 mt-0.5">{{ edit.proposed_text if edit.proposed_text is string else edit.get('proposed_text', '') }}</div>
                                </div>
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </section>
            {% endif %}
        </article>
    </div>
</div>
{% endblock %}
